<div class="container">
<h1 class="display-5 m-5">Carrinho de Compras</h1>

<% if session[:cart]&.any? %>
  <table class="table">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Preço Unitário</th>
        <th>Categoria</th>
      </tr>
    </thead>
    <tbody>
      <% preco_total = 0 %>
      <% pedidos = [] %>
      <% session[:cart].each do |product_id, quantity| %>
        <% product = Product.find(product_id) %>
        <tr>
          <td><%= product.name %></td>
          <td>R$<%= product.price.round(2) %></td>
          <td><%= product.category %></td>
          <% preco_total += product.price %>
          <% pedidos << product %>
        </tr>
      <% end %>
    </tbody>
  </table>
  <div class="row pt-3">
  <div class="col-6">
  <p><strong>Total: R$</strong><%= preco_total.round(2) %></p>
  </div>
  <div class="col-6 text-end">
  <%= button_to "Finalizar Compra", salvar_pedido_path(pedidos: pedidos), method: :post, class: "btn btn-success" %>
  </div>
  </div>
  <% else %>
  <p>Seu carrinho está vazio.</p>
  <% end %>
  </div>
  <!--  <form action="cart/procesar-pago" method="POST">
      <script src="https://www.mercadopago.cl/integrations/v1/web-
  payment-checkout.js" data-preference-id="<%= @preference_id %>">
      </script>
  </form> -->

  <script src="https://sdk.mercadopago.com/js/v2">
  </script>
   <div id="paymentBrick_container">
  </div>
  <script>
  const mp = new MercadoPago('TEST-e373d851-9f84-40fb-a3bd-05970e0d2c4b', {
    locale: 'pt'
  });
  const bricksBuilder = mp.bricks();
    const renderPaymentBrick = async (bricksBuilder) => {
      const settings = {
        initialization: {
          /*
            "amount" é a quantia total a pagar por todos os meios de pagamento com exceção da Conta Mercado Pago e Parcelas sem cartão de crédito, que têm seus valores de processamento determinados no backend através do "preferenceId"
          */
          amount: 10000,
          payer: {
            firstName: "",
            lastName: "",
            email: "",
          },
        },
        customization: {
          visual: {
            style: {
              theme: "default",
            },
          },
          paymentMethods: {
            creditCard: "all",
										atm: "all",
            maxInstallments: 1
          },
        },
        callbacks: {
          onReady: () => {
            /*
             Callback chamado quando o Brick está pronto.
             Aqui, você pode ocultar seu site, por exemplo.
            */
          },
          onSubmit: ({ selectedPaymentMethod, formData }) => {
            // callback chamado quando há click no botão de envio de dados
            return new Promise((resolve, reject) => {
              fetch("/process_payment", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
              })
                .then((response) => response.json())
                .then((response) => {
                  // receber o resultado do pagamento
                  resolve();
                })
                .catch((error) => {
                  // manejar a resposta de erro ao tentar criar um pagamento
                  reject();
                });
            });
          },
          onError: (error) => {
            // callback chamado para todos os casos de erro do Brick
            console.error(error);
          },
        },
      };
      window.paymentBrickController = await bricksBuilder.create(
        "payment",
        "paymentBrick_container",
        settings
      );
    };
    renderPaymentBrick(bricksBuilder);
  </script>
</body>